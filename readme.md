# 1. このツールは？

    XMLファイルをパースしてNLP向けにpostgresのデータベースに登録するためのツールです。

* 必要なライブラリなど
        基本的にOncwebの手順で実施する pip install で足りてたような気がしますが、
        メモとりもれましたので、ライブラリ関連でエラー出たら適宜対応してください

# 2. はじめに

* テーブルの登録方法

        ddl\create_table.sql を onsite DB で実行してください

* 接続情報とログ出力先とログレベル

        KUXML2DB\setting.py の各値を編集してください
    

# 3. コマンド単体での実行方法

* 病理レポートの場合

        python C:\\KUXML2DB\\KUXML2DB\\xml2dbl.py PATHOLOGY \\k7vciswebrpt1\\BF\\20231231

* 放射線レポートの場合

        python C:\\KUXML2DB\\KUXML2DB\\xml2dbl.py RADIOLOGY \\k7vciswebrpt1\\BG\\20231231

# 4. 期間を指定して病理/放射線レポートを取得する

    例.20231001 ～ 20212231を一括で取得するpowershell

        PS C:\KUXML2DB> .\bat\getReport.ps1 20231001 20231231

---
# 病理レポート単体テスト
| No  | 検証内容 | 期待値 | 結果 | 備考 | 実施日 | 実施者 |
|-|-|-|-|-|-|-|
|1|コマンド引数:引数なし|エラー終了|ok|--|2024/1/17|時田|
|2|コマンド引数:引数が不足|エラー終了|ok|--|2024/1/17|時田|
|3|コマンド引数:不正な引数|エラー終了|ok|--|2024/1/17|時田|
|4|コマンド引数:ディレクトリまでのパスが不正|エラー終了|ok|--|2024/1/17|時田|
|5|正常系:INSERTされた件数はXMLのファイル数と一致するか？|一致する|ok|--|2024/1/17|時田|
|6|正常系:繰り返し同一の引数で登録で重複してデータが登録されていないか？|登録されない|ok|--|2024/1/17|時田|
|7|正常系:各項目がすべてただしく登録されているか|登録されている|ok|--|2024/1/17|時田|
|8|正常系:病理所見などに欠損がないか？（実データの大きめのファイルで確認）|欠損が無い|ok|--|2024/1/17|時田|
|9|異常系:XMLフォーマットに不正なデータが含まれていた場合|エラーログになる。対象の日付のデータは登録されるがエラーデータのみ登録されない|NG|--|2024/1/17|時田|
|10|異常系:対象のディレクトリにXMLが０件|エラー終了||--|2024/1/17|時田|
|11|異常系:ファイルの読み込み処理中にファイルがロックされていないか？|コードレビュー：リードオンリーで開いて with ブロックで open している（つまり必ずcloseしていることを確認）||--|2024/1/17|時田|
|12|異常系:ファイルの読み込み処理中にファイルがロックされていないか？:実際の再現:ファイルOPENの次ステップなどにブレークポイントを配置してopenのままにする|openした状態で、他プロセスからのopeeが可能か？→可能||--|2024/1/17|時田|
|13|異常系:ファイルの読み込み処理中にファイルがロックされていないか？:実際の再現:ファイルOPENの次ステップなどにブレークポイントを配置してopenのままにする|その時点でプロセスを強制終了する。対象のファイル書き込みやファイル名変更や削除できるか？→可能||--|2024/1/17|時田|
|14|ログ:日付と時刻が表示されるか？|表示する||--|2024/1/17|時田|
|15|ログ:ログレベルが変更できるか？|変更出来る||--|2024/1/17|時田|
|16|ログ:infoレベルのログに個人情報が含まれていないか？|含まれていない||--|2024/1/17|時田|

# 放射線レポート単体テスト
| No  | 検証内容 | 期待値 | 結果 | 備考 | 実施日 | 実施者 |
|-|-|-|-|-|-|-|
|1|コマンド引数:引数なし|エラー終了||--|2024/1/17|時田|
|2|コマンド引数:引数が不足|エラー終了||--|2024/1/17|時田|
|3|コマンド引数:不正な引数|エラー終了||--|2024/1/17|時田|
|4|コマンド引数:ディレクトリまでのパスが不正|エラー終了||--|2024/1/17|時田|
|5|正常系:INSERTされた件数はXMLのファイル数と一致するか？|一致する||--|2024/1/17|時田|
|6|正常系:繰り返し同一の引数で登録で重複してデータが登録されていないか？|登録されない||--|2024/1/17|時田|
|7|正常系:各項目がすべてただしく登録されているか|登録されている||--|2024/1/17|時田|
|8|正常系:病理所見などに欠損がないか？（実データの大きめのファイルで確認）|欠損が無い||--|2024/1/17|時田|
|9|異常系:XMLフォーマットに不正なデータが含まれていた場合|エラーログになる。対象の日付のデータは登録されるがエラーデータのみ登録されない||--|2024/1/17|時田|
|10|異常系:対象のディレクトリにXMLが０件|エラー終了||--|2024/1/17|時田|
|11|異常系:ファイルの読み込み処理中にファイルがロックされていないか？|コードレビュー：リードオンリーで開いて with ブロックで open している（つまり必ずcloseしていることを確認）||--|2024/1/17|時田|
|12|異常系:ファイルの読み込み処理中にファイルがロックされていないか？:実際の再現:ファイルOPENの次ステップなどにブレークポイントを配置してopenのままにする|openした状態で、他プロセスからのopeeが可能か？→可能||--|2024/1/17|時田|
|13|異常系:ファイルの読み込み処理中にファイルがロックされていないか？:実際の再現:ファイルOPENの次ステップなどにブレークポイントを配置してopenのままにする|その時点でプロセスを強制終了する。対象のファイル書き込みやファイル名変更や削除できるか？→可能||--|2024/1/17|時田|
|14|ログ:日付と時刻が表示されるか？|表示する||--|2024/1/17|時田|
|15|ログ:ログレベルが変更できるか？|変更出来る||--|2024/1/17|時田|
|16|ログ:infoレベルのログに個人情報が含まれていないか？|含まれていない||--|2024/1/17|時田|
